AWSTemplateFormatVersion: "2010-09-09"
Description: Digital Identity IPV CRI Pdv-Matching API
Transform: [AWS::LanguageExtensions, AWS::Serverless-2016-10-31]

Parameters:
  AuditEventNamePrefix:
    Description: "The audit event name prefix"
    Type: AWS::SSM::Parameter::Value<String>
    Default: "/common-cri-parameters/AuditEventNamePrefix"
  BearerTokenName:
    Type: String
    Default: HMRCBearerToken
    Description: >-
      The name of the bearer token parameter.
      Temporary solution to be changed once cross account behaviour implemented.
  Environment:
    Type: String
    Default: dev
    AllowedValues: [dev, localdev, build, staging, integration, production]
    ConstraintDescription: must be dev, localdev, build, staging, integration or production
  CommonStackName:
    Type: String
    Default: common-cri-api
    Description: The name of the stack containing the common CRI lambdas/infra
  TxmaStackName:
    Type: String
    Default: txma-infrastructure
    Description: The name of the stack containing the common TxMA infrastructure
  CodeSigningConfigArn:
    Type: String
    Default: ""
  PermissionsBoundary:
    Type: String
    Default: ""
  DeployAlarmsInDevEnvironment:
    Description: "Set to the string value `true` to deploy alarms in a DEV environment"
    Type: String
    Default: false
  CriIdentifier:
    Description: "The unique credential issuer identifier"
    Type: AWS::SSM::Parameter::Value<String>
    Default: "/common-cri-parameters/CriIdentifier"
  SupportManualURL:
    Type: String
    Default: "https://team-manual.account.gov.uk/teams/CRI-Orange-team/supporting-cri-orange/hmrc-nino-runbook/#backend-api-alarms"
    Description: The support manual URL to be provided in alarm messages.
  LambdaDeploymentPreference:
    Description: "Specifies the configuration to enable gradual Lambda deployments. It can be used to set deployment type and also allows skipping canary deployment by setting to 'AllAtOnce'"
    Type: String
    Default: "AllAtOnce"
  StepFunctionsDeploymentPreference:
    Description: "Specifies the configuration to enable gradual StepFunction deployments. It can be used to set deployment type and also allows skipping canary deployment by setting to 'ALL_AT_ONCE'"
    Type: String
    Default: "ALL_AT_ONCE"
    AllowedValues:
      - ALL_AT_ONCE
      - CANARY
      - LINEAR

Conditions:
  EnforceCodeSigning: !Not [!Equals [!Ref CodeSigningConfigArn, ""]]
  UsePermissionsBoundary: !Not [!Equals [!Ref PermissionsBoundary, ""]]
  IsDevEnvironment: !Equals [!Ref Environment, dev]
  IsLocalDevEnvironment: !Equals [!Ref Environment, localdev]
  IsDevLikeEnvironment:
    !Or [!Condition IsLocalDevEnvironment, !Condition IsDevEnvironment]
  IsNotDevLikeEnvironment: !Not
    - !Condition IsDevLikeEnvironment
  UseCanaryDeploymentAlarms: !Or
    - !Not [ !Equals [ !Ref StepFunctionsDeploymentPreference, ALL_AT_ONCE ]]
    - !Not [ !Equals [ !Ref LambdaDeploymentPreference, AllAtOnce ]]
  DeployAlarms: !Or
    - !Condition IsNotDevLikeEnvironment
    - !Equals [!Ref DeployAlarmsInDevEnvironment, "true"]
Mappings:
  # Only numeric values should be assigned here
  MaxJwtTtl:
    Environment:
      dev: 2
      localdev: 2
      build: 2
      staging: 6
      integration: 6
      production: 6

  # Permitted values: SECONDS,MINUTES,HOURS,DAYS,MONTHS,YEARS
  JwtTtlUnit:
    Environment:
      dev: HOURS
      localdev: HOURS
      build: HOURS
      staging: MONTHS
      integration: MONTHS
      production: MONTHS

  Dynatrace:
    SecretArn:
      dev: arn:aws:secretsmanager:eu-west-2:216552277552:secret:DynatraceNonProductionVariables
      localdev: arn:aws:secretsmanager:eu-west-2:216552277552:secret:DynatraceNonProductionVariables
      build: arn:aws:secretsmanager:eu-west-2:216552277552:secret:DynatraceNonProductionVariables
      staging: arn:aws:secretsmanager:eu-west-2:216552277552:secret:DynatraceNonProductionVariables
      integration: arn:aws:secretsmanager:eu-west-2:216552277552:secret:DynatraceNonProductionVariables
      production: arn:aws:secretsmanager:eu-west-2:216552277552:secret:DynatraceProductionVariables

  Audit:
    EventName:
      ResponseReceived: RESPONSE_RECEIVED
      RequestSent: REQUEST_SENT
      VcIssued: VC_ISSUED
      End: END
      Abandoned: ABANDONED

  PlatformConfiguration:
    dev:
      CSLSEGRESS: arn:aws:logs:eu-west-2:885513274347:destination:csls_cw_logs_destination_prodpython-2
    build:
      CSLSEGRESS: arn:aws:logs:eu-west-2:885513274347:destination:csls_cw_logs_destination_prodpython-2
    staging:
      CSLSEGRESS: arn:aws:logs:eu-west-2:885513274347:destination:csls_cw_logs_destination_prodpython-2
    integration:
      CSLSEGRESS: arn:aws:logs:eu-west-2:885513274347:destination:csls_cw_logs_destination_prodpython-2
    production:
      CSLSEGRESS: arn:aws:logs:eu-west-2:885513274347:destination:csls_cw_logs_destination_prodpython-2

  EnvironmentConfiguration:
    localdev:
      DOMAINNAME: review-hc.localdev.account.gov.uk
    dev:
      DOMAINNAME: review-hc.dev.account.gov.uk
    build:
      DOMAINNAME: review-hc.build.account.gov.uk
    staging:
      DOMAINNAME: review-hc.staging.account.gov.uk
    integration:
      DOMAINNAME: review-hc.integration.account.gov.uk
    production:
      DOMAINNAME: review-hc.production.account.gov.uk

Globals:
  Function:
    Timeout: 30
    CodeUri: ..
    Runtime: nodejs18.x
    Architectures: [arm64]
    PermissionsBoundary:
      !If [UsePermissionsBoundary, !Ref PermissionsBoundary, !Ref AWS::NoValue]
    VpcConfig:
      SecurityGroupIds:
        - !ImportValue cri-vpc-AWSServicesEndpointSecurityGroupId
      SubnetIds:
        - !ImportValue cri-vpc-ProtectedSubnetIdA
        - !ImportValue cri-vpc-ProtectedSubnetIdB
    Layers:
      - !Sub
        - "{{resolve:secretsmanager:${SecretArn}:SecretString:NODEJS_LAYER}}"
        - SecretArn: !FindInMap [Dynatrace, SecretArn, !Ref Environment]
    Environment:
      Variables:
        NODE_OPTIONS: --enable-source-maps
        AWS_LAMBDA_EXEC_WRAPPER: /opt/dynatrace
        DT_OPEN_TELEMETRY_ENABLE_INTEGRATION: true
        POWERTOOLS_METRICS_NAMESPACE: !Ref CriIdentifier
        DT_CONNECTION_AUTH_TOKEN: !Sub
          - "{{resolve:secretsmanager:${SecretArn}:SecretString:DT_CONNECTION_AUTH_TOKEN}}"
          - SecretArn: !FindInMap [Dynatrace, SecretArn, !Ref Environment]
        DT_CONNECTION_BASE_URL: !Sub
          - "{{resolve:secretsmanager:${SecretArn}:SecretString:DT_CONNECTION_BASE_URL}}"
          - SecretArn: !FindInMap [Dynatrace, SecretArn, !Ref Environment]
        DT_CLUSTER_ID: !Sub
          - "{{resolve:secretsmanager:${SecretArn}:SecretString:DT_CLUSTER_ID}}"
          - SecretArn: !FindInMap [Dynatrace, SecretArn, !Ref Environment]
        DT_LOG_COLLECTION_AUTH_TOKEN: !Sub
          - "{{resolve:secretsmanager:${SecretArn}:SecretString:DT_LOG_COLLECTION_AUTH_TOKEN}}"
          - SecretArn: !FindInMap [Dynatrace, SecretArn, !Ref Environment]
        DT_TENANT: !Sub
          - "{{resolve:secretsmanager:${SecretArn}:SecretString:DT_TENANT}}"
          - SecretArn: !FindInMap [Dynatrace, SecretArn, !Ref Environment]
    AutoPublishAlias: live

Resources:
  RedactionLogStreamTrackingTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub ${AWS::StackName}-redaction-logstream-tracking
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: logStreamName
          AttributeType: S
      KeySchema:
        - AttributeName: logStreamName
          KeyType: HASH
      TimeToLiveSpecification:
        AttributeName: expiryDate
        Enabled: true

  CiMappingFunction:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Sourcemap: true
    Properties:
      Handler: lambdas/ci-mapping/src/ci-mapping-handler.lambdaHandler
      LoggingConfig:
        LogGroup: !Sub /aws/lambda/${AWS::StackName}/CiMappingFunction
      CodeSigningConfigArn:
        !If [EnforceCodeSigning, !Ref CodeSigningConfigArn, !Ref AWS::NoValue]
      Environment:
        Variables:
          POWERTOOLS_SERVICE_NAME: !Sub "${CriIdentifier}-CiMapping"

  CiMappingFunctionLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub /aws/lambda/${AWS::StackName}/CiMappingFunction
      RetentionInDays: 30

  CiMappingFunctionLogsSubscriptionFilterCSLS:
    Type: AWS::Logs::SubscriptionFilter
    Condition: IsNotDevLikeEnvironment
    Properties:
      DestinationArn:
        !FindInMap [PlatformConfiguration, !Ref Environment, CSLSEGRESS]
      FilterPattern: ""
      LogGroupName: !Ref CiMappingFunctionLogGroup

  CredentialSubjectFunction:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Sourcemap: true
    Properties:
      Handler: lambdas/credential-subject/src/credential-subject-handler.lambdaHandler
      LoggingConfig:
        LogGroup: !Sub /aws/lambda/${AWS::StackName}/CredentialSubjectFunction
      CodeSigningConfigArn:
        !If [EnforceCodeSigning, !Ref CodeSigningConfigArn, !Ref AWS::NoValue]
      Environment:
        Variables:
          POWERTOOLS_SERVICE_NAME: !Sub "${CriIdentifier}-CredentialSubject"

  CredentialSubjectFunctionLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub /aws/lambda/${AWS::StackName}/CredentialSubjectFunction
      RetentionInDays: 30

  CredentialSubjectFunctionLogsSubscriptionFilterCSLS:
    Type: AWS::Logs::SubscriptionFilter
    Condition: IsNotDevLikeEnvironment
    Properties:
      DestinationArn:
        !FindInMap [PlatformConfiguration, !Ref Environment, CSLSEGRESS]
      FilterPattern: ""
      LogGroupName: !Ref CredentialSubjectFunctionLogGroup

  JwtSignerFunction:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Sourcemap: true
    Properties:
      Handler: lambdas/jwt-signer/src/jwt-signer-handler.lambdaHandler
      LoggingConfig:
        LogGroup: !Sub /aws/lambda/${AWS::StackName}/JwtSignerFunction
      CodeSigningConfigArn:
        !If [EnforceCodeSigning, !Ref CodeSigningConfigArn, !Ref AWS::NoValue]
      Policies:
        - Statement:
            Effect: Allow
            Action: kms:Sign
            Resource: !ImportValue core-infrastructure-CriVcSigningKey1Arn
      Environment:
        Variables:
          POWERTOOLS_SERVICE_NAME: !Sub "${CriIdentifier}-JwtSigner"
          DOMAIN_NAME: !FindInMap [EnvironmentConfiguration, !Ref Environment, DOMAINNAME]

  JwtSignerFunctionLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub /aws/lambda/${AWS::StackName}/JwtSignerFunction
      RetentionInDays: 30

  JwtSignerFunctionLogsSubscriptionFilterCSLS:
    Type: AWS::Logs::SubscriptionFilter
    Condition: IsNotDevLikeEnvironment
    Properties:
      DestinationArn:
        !FindInMap [PlatformConfiguration, !Ref Environment, CSLSEGRESS]
      FilterPattern: ""
      LogGroupName: !Ref JwtSignerFunctionLogGroup

  OTGFunction:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Sourcemap: true
    Properties:
      Handler: lambdas/otg-api/src/otg-api-handler.lambdaHandler
      LoggingConfig:
        LogGroup: !Sub /aws/lambda/${AWS::StackName}/OTGFunction
      CodeSigningConfigArn:
        !If [EnforceCodeSigning, !Ref CodeSigningConfigArn, !Ref AWS::NoValue]
      Environment:
        Variables:
          POWERTOOLS_SERVICE_NAME: !Sub "${CriIdentifier}-OTG"

  OTGFunctionLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub /aws/lambda/${AWS::StackName}/OTGFunction
      RetentionInDays: 30

  OTGFunctionLogsSubscriptionFilterCSLS:
    Type: AWS::Logs::SubscriptionFilter
    Condition: IsNotDevLikeEnvironment
    Properties:
      DestinationArn:
        !FindInMap [PlatformConfiguration, !Ref Environment, CSLSEGRESS]
      FilterPattern: ""
      LogGroupName: !Ref OTGFunctionLogGroup

  OTGFunctionFatalErrorMetricFilter:
    Type: AWS::Logs::MetricFilter
    Properties:
      LogGroupName: !Ref OTGFunctionLogGroup
      FilterPattern: '{ $.level = "FATAL" || $.message = "Unhandled Exception:*" }'
      MetricTransformations:
        - MetricValue: "1"
          MetricNamespace: !Sub "${AWS::StackName}/LogMessages"
          MetricName: "OTGFunction-Fatalerror"

  CheckHmrcLambdaConcurrency80Alarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub ${AWS::StackName}-CheckHmrcLambdaConcurrency80-alarm
      AlarmDescription: !Sub Check HMRC ${Environment} lambdas alarm if over 80% of concurrent executions is used ${SupportManualURL}"
      ActionsEnabled: true
      AlarmActions:
        - !ImportValue platform-alarm-warning-alert-topic
      OKActions:
        - !ImportValue platform-alarm-warning-alert-topic
      InsufficientDataActions: []
      MetricName: ConcurrentExecutions
      Namespace: AWS/Lambda
      Statistic: Maximum
      Period: 60
      EvaluationPeriods: 1
      DatapointsToAlarm: 1
      Threshold: 780
      ComparisonOperator: GreaterThanThreshold
      TreatMissingData: notBreaching

  CheckHmrcLambdaErrors:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub ${AWS::StackName}-CheckHmrcLambdaErrors-alarm
      AlarmDescription: !Sub Check HMRC ${Environment} lambda errors"
      ActionsEnabled: true
      AlarmActions:
        - !ImportValue core-infrastructure-AlarmTopic
      OKActions:
        - !ImportValue core-infrastructure-AlarmTopic
      InsufficientDataActions: []
      MetricName: Errors
      Namespace: AWS/Lambda
      Statistic: Sum
      Period: 300
      EvaluationPeriods: 3
      DatapointsToAlarm: 3
      Threshold: 1
      ComparisonOperator: GreaterThanOrEqualToThreshold
      TreatMissingData: notBreaching

  CheckHmrcLambdaThrottle:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub ${AWS::StackName}-CheckHmrcLambdaThrottle-alarm
      AlarmDescription: !Sub Check HMRC ${Environment} lambda throttle"
      ActionsEnabled: true
      AlarmActions:
        - !ImportValue core-infrastructure-AlarmTopic
      OKActions:
        - !ImportValue core-infrastructure-AlarmTopic
      InsufficientDataActions: []
      MetricName: Throttles
      Namespace: AWS/Lambda
      Statistic: Sum
      Period: 300
      EvaluationPeriods: 3
      DatapointsToAlarm: 3
      Threshold: 1
      ComparisonOperator: GreaterThanOrEqualToThreshold
      TreatMissingData: notBreaching

  MatchingFunction:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Sourcemap: true
    Properties:
      Handler: lambdas/matching/src/matching-handler.lambdaHandler
      LoggingConfig:
        LogGroup: !Sub /aws/lambda/${AWS::StackName}/MatchingFunction
      CodeSigningConfigArn:
        !If [EnforceCodeSigning, !Ref CodeSigningConfigArn, !Ref AWS::NoValue]
      Environment:
        Variables:
          POWERTOOLS_SERVICE_NAME: !Sub "${CriIdentifier}-Matching"

  MatchingFunctionLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub /aws/lambda/${AWS::StackName}/MatchingFunction
      RetentionInDays: 30

  MatchingFunctionLogsSubscriptionFilterCSLS:
    Type: AWS::Logs::SubscriptionFilter
    Condition: IsNotDevLikeEnvironment
    Properties:
      DestinationArn:
        !FindInMap [PlatformConfiguration, !Ref Environment, CSLSEGRESS]
      FilterPattern: ""
      LogGroupName: !Ref MatchingFunctionLogGroup

  SsmParametersFunction:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Sourcemap: true
    Properties:
      Handler: lambdas/ssm-parameters/src/ssm-parameters-handler.lambdaHandler
      LoggingConfig:
        LogGroup: !Sub /aws/lambda/${AWS::StackName}/SsmParametersFunction
      CodeSigningConfigArn:
        !If [EnforceCodeSigning, !Ref CodeSigningConfigArn, !Ref AWS::NoValue]
      Policies:
        - SSMParameterReadPolicy:
            ParameterName: "*"
      Environment:
        Variables:
          POWERTOOLS_SERVICE_NAME: !Sub "${CriIdentifier}-SsmParameters"

  SsmParametersFunctionLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub /aws/lambda/${AWS::StackName}/SsmParametersFunction
      RetentionInDays: 30

  SsmParametersFunctionLogsSubscriptionFilterCSLS:
    Type: AWS::Logs::SubscriptionFilter
    Condition: IsNotDevLikeEnvironment
    Properties:
      DestinationArn:
        !FindInMap [PlatformConfiguration, !Ref Environment, CSLSEGRESS]
      FilterPattern: ""
      LogGroupName: !Ref SsmParametersFunctionLogGroup

  TimeFunction:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Sourcemap: true
    Properties:
      Handler: lambdas/time-handler/src/time-handler.lambdaHandler
      LoggingConfig:
        LogGroup: !Sub /aws/lambda/${AWS::StackName}/TimeFunction
      CodeSigningConfigArn:
        !If [EnforceCodeSigning, !Ref CodeSigningConfigArn, !Ref AWS::NoValue]
      Environment:
        Variables:
          POWERTOOLS_SERVICE_NAME: !Sub "${CriIdentifier}-Time"

  TimeFunctionLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub /aws/lambda/${AWS::StackName}/TimeFunction
      RetentionInDays: 30

  TimeFunctionLogsSubscriptionFilterCSLS:
    Type: AWS::Logs::SubscriptionFilter
    Condition: IsNotDevLikeEnvironment
    Properties:
      DestinationArn:
        !FindInMap [PlatformConfiguration, !Ref Environment, CSLSEGRESS]
      FilterPattern: ""
      LogGroupName: !Ref TimeFunctionLogGroup

  UserAgent:
    Type: AWS::SSM::Parameter
    Properties:
      Type: String
      Name: !Sub /${AWS::StackName}/UserAgent
      Value: govuk-one-login
      Description: User agent for HMRC requests

  MaxJwtTtlParameter:
    Type: AWS::SSM::Parameter
    Properties:
      Type: String
      Name: !Sub /${AWS::StackName}/MaxJwtTtl
      Value: !FindInMap [MaxJwtTtl, Environment, !Ref Environment]
      Description: Default time to live for an JWT in (seconds)

  JwtTtlUnitParameter:
    Type: AWS::SSM::Parameter
    Properties:
      Type: String
      Name: !Sub /${AWS::StackName}/JwtTtlUnit
      Value: !FindInMap [JwtTtlUnit, Environment, !Ref Environment]
      Description: The unit for the time-to-live for an JWT e.g. (MONTHS)

  PublicNinoCheckApi:
    Type: AWS::Serverless::Api
    Properties:
      Description: Public NINO Check CRI API
      MethodSettings:
        - LoggingLevel: INFO
          ResourcePath: "/*"
          HttpMethod: "*"
          DataTraceEnabled: true
          MetricsEnabled: true
          ThrottlingRateLimit: 200
          ThrottlingBurstLimit: 400
      AccessLogSetting:
        DestinationArn: !GetAtt PublicNinoCheckApiAccessLogGroup.Arn
        Format:
          Fn::ToJsonString:
            requestId: $context.requestId
            ip: $context.identity.sourceIp
            requestTime: $context.requestTime
            httpMethod: $context.httpMethod
            path: $context.path
            routeKey: $context.routeKey
            status: $context.status
            protocol: $context.protocol
            responseLatency: $context.responseLatency
            responseLength: $context.responseLength
      TracingEnabled: true
      Name: !Sub ${AWS::StackName}-public
      StageName: !Ref Environment
      DefinitionBody:
        openapi: 3.0.1
        Fn::Transform:
          Name: AWS::Include
          Parameters:
            Location: public-api.yaml
      OpenApiVersion: 3.0.1
      EndpointConfiguration:
        Type: REGIONAL

  PublicNinoCheckApiAccessLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub "/aws/vendedlogs/apigateway/${AWS::StackName}-${PublicNinoCheckApi}-public-AccessLogs"
      RetentionInDays: 30

  PublicNinoCheckApiLogsSubscriptionFilterCSLS:
    Type: AWS::Logs::SubscriptionFilter
    Condition: IsNotDevLikeEnvironment
    Properties:
      DestinationArn:
        !FindInMap [PlatformConfiguration, !Ref Environment, CSLSEGRESS]
      FilterPattern: ""
      LogGroupName: !Ref PublicNinoCheckApiAccessLogGroup

  PublicNinoCheckApiFatalErrorMetricFilter:
    Type: AWS::Logs::MetricFilter
    Properties:
      LogGroupName: !Ref PublicNinoCheckApiAccessLogGroup
      FilterPattern: '{ $.level = "FATAL" || $.message = "Unhandled Exception:*" }'
      MetricTransformations:
        - MetricValue: "1"
          MetricNamespace: !Sub "${AWS::StackName}/LogMessages"
          MetricName: "PublicNinoCheckApi-Fatalerror"

  PublicNinoCheckApiFatalErrorAlarm:
    DependsOn:
      - "PublicNinoCheckApiFatalErrorMetricFilter"
    Type: AWS::CloudWatch::Alarm
    Condition: "DeployAlarms"
    Properties:
      AlarmName: !Sub "${AWS::StackName}-${Environment}-PublicNinoCheckApi-FatalError-alarm"
      AlarmDescription: !Sub "Trigger an alarm when Fatal ${PublicNinoCheckApi} Error occurs. ${SupportManualURL}"
      ActionsEnabled: true
      AlarmActions:
        - !ImportValue core-infrastructure-AlarmTopic
        - !ImportValue platform-alarm-critical-alert-topic
      OKActions:
        - !ImportValue core-infrastructure-AlarmTopic
        - !ImportValue platform-alarm-critical-alert-topic
      InsufficientDataActions: []
      MetricName: PublicNinoCheckApi-Fatalerror
      Namespace: !Sub "${AWS::StackName}/LogMessages"
      Statistic: Sum
      Dimensions: []
      Period: 60
      EvaluationPeriods: 1
      DatapointsToAlarm: 1
      Threshold: 1
      ComparisonOperator: GreaterThanOrEqualToThreshold
      TreatMissingData: notBreaching

  PrivateNinoCheckApi:
    Type: AWS::Serverless::Api
    Properties:
      Description: Private NINO Check CRI API
      MethodSettings:
        - LoggingLevel: INFO
          ResourcePath: "/*"
          HttpMethod: "*"
          DataTraceEnabled: true
          MetricsEnabled: true
          ThrottlingRateLimit: 200
          ThrottlingBurstLimit: 400
      AccessLogSetting:
        DestinationArn: !GetAtt PrivateNinoCheckApiAccessLogGroup.Arn
        Format:
          Fn::ToJsonString:
            requestId: $context.requestId
            ip: $context.identity.sourceIp
            requestTime: $context.requestTime
            httpMethod: $context.httpMethod
            path: $context.path
            routeKey: $context.routeKey
            status: $context.status
            protocol: $context.protocol
            responseLatency: $context.responseLatency
            responseLength: $context.responseLength
      TracingEnabled: true
      Name: !Sub ${AWS::StackName}-private
      StageName: !Ref Environment
      DefinitionBody:
        openapi: 3.0.1
        paths: # workaround to get `sam validate` to work
          /never-created:
            options: {}
        Fn::Transform:
          Name: AWS::Include
          Parameters:
            Location: private-api.yaml
      OpenApiVersion: 3.0.1
      EndpointConfiguration:
        Type: !If [IsLocalDevEnvironment, REGIONAL, PRIVATE]
      Auth:
        ResourcePolicy: !If
          - IsLocalDevEnvironment
          - !Ref AWS::NoValue
          - CustomStatements:
              - Effect: Allow
                Resource: execute-api:/*
                Action: execute-api:Invoke
                Principal: "*"

  PrivateNinoCheckApiAccessLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub "/aws/vendedlogs/apigateway/${AWS::StackName}-${PrivateNinoCheckApi}-private-AccessLogs"
      RetentionInDays: 30

  PrivateNinoCheckApiLogsSubscriptionFilterCSLS:
    Type: AWS::Logs::SubscriptionFilter
    Condition: IsNotDevLikeEnvironment
    Properties:
      DestinationArn:
        !FindInMap [PlatformConfiguration, !Ref Environment, CSLSEGRESS]
      FilterPattern: ""
      LogGroupName: !Ref PrivateNinoCheckApiAccessLogGroup

  PrivateNinoCheckApiFatalErrorMetricFilter:
    Type: AWS::Logs::MetricFilter
    Properties:
      LogGroupName: !Ref PrivateNinoCheckApiAccessLogGroup
      FilterPattern: '{ $.level = "FATAL" || $.message = "Unhandled Exception:*" }'
      MetricTransformations:
        - MetricValue: "1"
          MetricNamespace: !Sub "${AWS::StackName}/LogMessages"
          MetricName: "PrivateNinoCheckApi-Fatalerror"

  PrivateNinoCheckApiFatalErrorAlarm:
    DependsOn:
      - "PrivateNinoCheckApiFatalErrorMetricFilter"
    Type: AWS::CloudWatch::Alarm
    Condition: "DeployAlarms"
    Properties:
      AlarmName: !Sub "${AWS::StackName}-${Environment}-PrivateNinoCheckApi-FatalError-alarm"
      AlarmDescription: !Sub "Trigger an alarm when Fatal ${PrivateNinoCheckApi} Error occurs. ${SupportManualURL}"
      ActionsEnabled: true
      AlarmActions:
        - !ImportValue core-infrastructure-AlarmTopic
        - !ImportValue platform-alarm-critical-alert-topic
      OKActions:
        - !ImportValue core-infrastructure-AlarmTopic
        - !ImportValue platform-alarm-critical-alert-topic
      InsufficientDataActions: []
      MetricName: PrivateNinoCheckApi-Fatalerror
      Namespace: !Sub "${AWS::StackName}/LogMessages"
      Statistic: Sum
      Dimensions: []
      Period: 60
      EvaluationPeriods: 1
      DatapointsToAlarm: 1
      Threshold: 1
      ComparisonOperator: GreaterThanOrEqualToThreshold
      TreatMissingData: notBreaching

  ExecuteStateMachineRole:
    Type: AWS::IAM::Role
    Properties:
      Description: Role to allow API gateway to execute step function
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Action: sts:AssumeRole
            Principal:
              Service: apigateway.amazonaws.com
      Policies:
        - PolicyName: AllowStateMachineInvoke
          PolicyDocument:
            Version: 2012-10-17
            Statement:
              - Effect: Allow
                Resource: "*"
                Action:
                  - states:StartExecution
                  - states:StartSyncExecution
      PermissionsBoundary: !If
        - UsePermissionsBoundary
        - !Ref PermissionsBoundary
        - !Ref AWS::NoValue

  UserAttemptsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub ${AWS::StackName}-user-attempts
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: sessionId
          AttributeType: S
        - AttributeName: timestamp
          AttributeType: S
      KeySchema:
        - AttributeName: sessionId
          KeyType: HASH
        - AttributeName: timestamp
          KeyType: RANGE
      TimeToLiveSpecification:
        AttributeName: ttl
        Enabled: true

  NinoUsersTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub ${AWS::StackName}-nino-users
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: sessionId
          AttributeType: S
      KeySchema:
        - AttributeName: sessionId
          KeyType: HASH
      TimeToLiveSpecification:
        AttributeName: ttl
        Enabled: true

  CheckSessionStateMachine:
    Type: AWS::Serverless::StateMachine
    Properties:
      AutoPublishAlias: live
      DeploymentPreference:
        Type: !Ref StepFunctionsDeploymentPreference
        Interval: 15
        Percentage: 10
        Alarms: !If
          - UseCanaryDeploymentAlarms
          - - !Ref TimeFunctionCanaryErrors
            - !Ref CheckSessionStateMachineFailedCanary
          - !Ref AWS::NoValue
        StateMachineVersionArn: !Sub "arn:aws:states:${AWS::Region}:${AWS::AccountId}:stateMachine:${CheckSessionStateMachine}:live"
      Type: EXPRESS
      DefinitionUri: ../step-functions/check_session.asl.json
      DefinitionSubstitutions:
        TimeFunctionArn: !Ref TimeFunction.Version
        CommonStackName: !Ref CommonStackName
      Logging:
        Destinations:
          - CloudWatchLogsLogGroup:
              LogGroupArn: !GetAtt CheckSessionStateMachineLogGroup.Arn
        IncludeExecutionData: True
        Level: ALL
      Policies:
        - LambdaInvokePolicy:
            FunctionName: !Ref TimeFunction
        - DynamoDBReadPolicy:
            TableName: !Sub "{{resolve:ssm:/${CommonStackName}/SessionTableName}}"
        - Statement:
            Effect: Allow
            Action: logs:*
            Resource: "*"
      PermissionsBoundary: !If
        - UsePermissionsBoundary
        - !Ref PermissionsBoundary
        - !Ref AWS::NoValue

  CheckSessionStateMachineFailedMetric:
    Type: AWS::Logs::MetricFilter
    Properties:
      LogGroupName: !Ref CheckSessionStateMachineLogGroup
      FilterPattern: '{($.type = "ExecutionFailed")}'
      MetricTransformations:
        - MetricValue: "1"
          MetricName: "CheckSessionStateMachine-Error"
          MetricNamespace: !Sub "${AWS::StackName}/LogMessages"

  CheckSessionStateMachineAlarm:
    Type: "AWS::CloudWatch::Alarm"
    Condition: "DeployAlarms"
    Properties:
      OKActions:
        - !ImportValue core-infrastructure-AlarmTopic
        - !ImportValue platform-alarm-critical-alert-topic
      AlarmActions:
        - !ImportValue core-infrastructure-AlarmTopic
        - !ImportValue platform-alarm-critical-alert-topic
      AlarmDescription: !Sub "${CheckSessionStateMachine} failed 4 or more requests in the last hour. ${SupportManualURL}"
      AlarmName: !Sub "${AWS::StackName}-${Environment}-CheckSessionStateMachine-alarm"
      MetricName: "ExecutionsFailed"
      Namespace: AWS/States
      ComparisonOperator: GreaterThanThreshold
      Statistic: Sum
      DatapointsToAlarm: 1
      EvaluationPeriods: 1
      Period: 3600
      Threshold: 3
      TreatMissingData: notBreaching
      Dimensions:
        - Name: StateMachineArn
          Value: !Ref CheckSessionStateMachine

  NinoCheckStateMachine:
    Type: AWS::Serverless::StateMachine
    Properties:
      AutoPublishAlias: live
      DeploymentPreference:
        Type: !Ref StepFunctionsDeploymentPreference
        Interval: 15
        Percentage: 10
        Alarms: !If
          - UseCanaryDeploymentAlarms
          - - !Ref OTGFunctionCanaryErrors
            - !Ref TimeFunctionCanaryErrors
            - !Ref MatchingFunctionCanaryErrors
            - !Ref SsmParametersFunctionCanaryErrors
            - !Ref NinoCheckStateMachineFailedCanary
          - !Ref AWS::NoValue
        StateMachineVersionArn: !Sub "arn:aws:states:${AWS::Region}:${AWS::AccountId}:stateMachine:${NinoCheckStateMachine}:live"
      Type: EXPRESS
      DefinitionUri: ../step-functions/nino_check.asl.json
      DefinitionSubstitutions:
        AuditEventPrefix: !Ref AuditEventNamePrefix
        CheckSessionStateMachineArn: !Sub ${CheckSessionStateMachine}:live
        TimeFunctionArn: !Ref TimeFunction.Version
        MatchingFunctionArn: !Ref MatchingFunction.Version
        UserAttemptsTable: !Ref UserAttemptsTable
        NinoUsersTable: !Ref NinoUsersTable
        UserAgent: !Ref UserAgent
        BearerTokenName: !Ref BearerTokenName
        CommonStackName: !Ref CommonStackName
        SsmParametersFunction: !Ref SsmParametersFunction.Version
        OTGFunction: !Ref OTGFunction.Version
        CheckHmrcEventBus: !Ref CheckHmrcEventBus
        CheckHmrcEventBusSource: !FindInMap [EnvironmentConfiguration, !Ref Environment, DOMAINNAME]
        AuditEventNameResponseReceived:
          !FindInMap [Audit, EventName, ResponseReceived]
        AuditEventNameRequestSent: !FindInMap [Audit, EventName, RequestSent]
      Logging:
        Destinations:
          - CloudWatchLogsLogGroup:
              LogGroupArn: !GetAtt NinoCheckStateMachineLogGroup.Arn
        IncludeExecutionData: True
        Level: ALL
      Policies:
        - LambdaInvokePolicy:
            FunctionName: !Ref OTGFunction
        - LambdaInvokePolicy:
            FunctionName: !Ref SsmParametersFunction
        - LambdaInvokePolicy:
            FunctionName: !Ref TimeFunction
        - LambdaInvokePolicy:
            FunctionName: !Ref MatchingFunction
        - DynamoDBReadPolicy:
            TableName: !Sub "{{resolve:ssm:/${CommonStackName}/SessionTableName}}"
        - DynamoDBWritePolicy:
            TableName: !Sub "{{resolve:ssm:/${CommonStackName}/SessionTableName}}"
        - DynamoDBWritePolicy:
            TableName: !Ref UserAttemptsTable
        - DynamoDBReadPolicy:
            TableName: !Ref UserAttemptsTable
        - DynamoDBReadPolicy:
            TableName: !Ref NinoUsersTable
        - DynamoDBWritePolicy:
            TableName: !Ref NinoUsersTable
        - DynamoDBReadPolicy:
            TableName: !Sub "{{resolve:ssm:/${CommonStackName}/PersonIdentityTableName}}"
        - AWSSecretsManagerGetSecretValuePolicy:
            SecretArn: !Sub arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:${BearerTokenName}-??????
        - EventBridgePutEventsPolicy:
            EventBusName: !Ref CheckHmrcEventBus
        - Statement:
            Effect: Allow
            Action:
              - states:StartSyncExecution
              - states:StartExecution
            Resource:
              - !Ref CheckSessionStateMachine
        - Statement:
            Effect: Allow
            Action:
              - ssm:GetParameters
              - ssm:GetParameter
            Resource:
              - !Sub "arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/check-hmrc-cri-api/NinoCheckUrl/*"
              - !Sub "arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter${UserAgent}"
              - !Sub "arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/${CommonStackName}/SessionTableName"
              - !Sub "arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/${CommonStackName}/PersonIdentityTableName"
        - Statement:
            Effect: Allow
            Action: logs:*
            Resource: "*"
      PermissionsBoundary: !If
        - UsePermissionsBoundary
        - !Ref PermissionsBoundary
        - !Ref AWS::NoValue

  NinoCheckStateMachineLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub "/aws/vendedlogs/states/${AWS::StackName}-NinoCheck-state-machine-logs"
      RetentionInDays: 30

  PIIRedactedNinoCheckStateMachineLogsSubscriptionFilterCSLS:
    Type: AWS::Logs::SubscriptionFilter
    Condition: IsNotDevLikeEnvironment
    Properties:
      DestinationArn:
        !FindInMap [PlatformConfiguration, !Ref Environment, CSLSEGRESS]
      FilterPattern: ""
      LogGroupName: !Ref PIIRedactedNinoCheckStateMachineLogGroup

  NinoCheckStateMachineFailedMetric:
    Type: AWS::Logs::MetricFilter
    Properties:
      LogGroupName: !Ref NinoCheckStateMachineLogGroup
      FilterPattern: '{$.type = "ExecutionFailed"}'
      MetricTransformations:
        - MetricValue: "1"
          MetricName: "NinoCheckStateMachine-Error"
          MetricNamespace: !Sub "${AWS::StackName}/LogMessages"

  NinoCheckStateMachineAlarm:
    Type: "AWS::CloudWatch::Alarm"
    Condition: "DeployAlarms"
    Properties:
      OKActions:
        - !ImportValue core-infrastructure-AlarmTopic
        - !ImportValue platform-alarm-critical-alert-topic
      AlarmActions:
        - !ImportValue core-infrastructure-AlarmTopic
        - !ImportValue platform-alarm-critical-alert-topic
      AlarmDescription: !Sub "${NinoCheckStateMachine} failed 4 or more requests in the last hour. ${SupportManualURL}"
      AlarmName: !Sub "${AWS::StackName}-${Environment}-NinoCheckStateMachine-ExecutionsFailed-alarm"
      MetricName: "ExecutionsFailed"
      Namespace: AWS/States
      ComparisonOperator: GreaterThanThreshold
      Statistic: Sum
      DatapointsToAlarm: 1
      EvaluationPeriods: 1
      Period: 3600
      Threshold: 3
      TreatMissingData: notBreaching
      Dimensions:
        - Name: StateMachineArn
          Value: !Ref NinoCheckStateMachine

  AbandonStateMachine:
    Type: AWS::Serverless::StateMachine
    Properties:
      AutoPublishAlias: live
      DeploymentPreference:
        Type: !Ref StepFunctionsDeploymentPreference
        Interval: 15
        Percentage: 10
        Alarms: !If
          - UseCanaryDeploymentAlarms
          - - !Ref SsmParametersFunctionCanaryErrors
            - !Ref AbandonStateMachineFailedCanary
          - !Ref AWS::NoValue
        StateMachineVersionArn: !Sub "arn:aws:states:${AWS::Region}:${AWS::AccountId}:stateMachine:${AbandonStateMachine}:live"
      Type: EXPRESS
      DefinitionUri: ../step-functions/abandon.asl.json
      DefinitionSubstitutions:
        AuditEventPrefix: !Ref AuditEventNamePrefix
        CheckSessionStateMachineArn: !Sub ${CheckSessionStateMachine}:live
        CommonStackName: !Ref CommonStackName
        SsmParametersFunction: !Ref SsmParametersFunction.Version
        CheckHmrcEventBus: !Ref CheckHmrcEventBus
        CheckHmrcEventBusSource: !FindInMap [EnvironmentConfiguration, !Ref Environment, DOMAINNAME]
        AuditEventNameAbandoned: !FindInMap [Audit, EventName, Abandoned]
      Logging:
        Destinations:
          - CloudWatchLogsLogGroup:
              LogGroupArn: !GetAtt AbandonStateMachineLogGroup.Arn
        IncludeExecutionData: True
        Level: ALL
      Policies:
        - LambdaInvokePolicy:
            FunctionName: !Ref SsmParametersFunction
        - DynamoDBReadPolicy:
            TableName: !Sub "{{resolve:ssm:/${CommonStackName}/SessionTableName}}"
        - DynamoDBWritePolicy:
            TableName: !Sub "{{resolve:ssm:/${CommonStackName}/SessionTableName}}"
        - EventBridgePutEventsPolicy:
            EventBusName: !Ref CheckHmrcEventBus
        - Statement:
            Effect: Allow
            Action:
              - states:StartSyncExecution
              - states:StartExecution
            Resource:
              - !Ref CheckSessionStateMachine
        - Statement:
            Effect: Allow
            Action: logs:*
            Resource: "*"
      PermissionsBoundary: !If
        - UsePermissionsBoundary
        - !Ref PermissionsBoundary
        - !Ref AWS::NoValue

  AbandonStateMachineLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub "/aws/vendedlogs/states/${AWS::StackName}-Abandon-state-machine-logs"
      RetentionInDays: 30

  PIIRedactedAbandonStateMachineLogsSubscriptionFilterCSLS:
    Type: AWS::Logs::SubscriptionFilter
    Condition: IsNotDevLikeEnvironment
    Properties:
      DestinationArn:
        !FindInMap [PlatformConfiguration, !Ref Environment, CSLSEGRESS]
      FilterPattern: ""
      LogGroupName: !Ref PIIRedactedAbandonStateMachineLogGroup

  AbandonStateMachineFailedMetric:
    Type: AWS::Logs::MetricFilter
    Properties:
      LogGroupName: !Ref AbandonStateMachineLogGroup
      FilterPattern: '{$.type = "ExecutionFailed"}'
      MetricTransformations:
        - MetricValue: "1"
          MetricName: "AbandonStateMachine}-Error"
          MetricNamespace: !Sub "${AWS::StackName}/LogMessages"

  AbandonStateMachineAlarm:
    Type: "AWS::CloudWatch::Alarm"
    Condition: "DeployAlarms"
    Properties:
      OKActions:
        - !ImportValue platform-alarm-warning-alert-topic
      AlarmActions:
        - !ImportValue platform-alarm-warning-alert-topic
      AlarmDescription: !Sub "${AbandonStateMachine} failed 4 or more requests in the last hour. ${SupportManualURL}"
      AlarmName: !Sub "${AWS::StackName}-${Environment}-AbandonStateMachine-ExecutionsFailed-alarm"
      MetricName: "ExecutionsFailed"
      Namespace: AWS/States
      ComparisonOperator: GreaterThanThreshold
      Statistic: Sum
      DatapointsToAlarm: 1
      EvaluationPeriods: 1
      Period: 3600
      Threshold: 3
      TreatMissingData: notBreaching
      Dimensions:
        - Name: StateMachineArn
          Value: !Ref AbandonStateMachine

  NinoIssueCredentialStateMachine:
    Type: AWS::Serverless::StateMachine
    Properties:
      AutoPublishAlias: live
      DeploymentPreference:
        Type: !Ref StepFunctionsDeploymentPreference
        Interval: 15
        Percentage: 10
        Alarms: !If
          - UseCanaryDeploymentAlarms
          - - !Ref CiMappingFunctionCanaryErrors
            - !Ref TimeFunctionCanaryErrors
            - !Ref CredentialSubjectFunctionCanaryErrors
            - !Ref JwtSignerFunctionCanaryErrors
            - !Ref SsmParametersFunctionCanaryErrors
            - !Ref NinoIssueCredentialStateMachineFailedCanary
          - !Ref AWS::NoValue
        StateMachineVersionArn: !Sub "arn:aws:states:${AWS::Region}:${AWS::AccountId}:stateMachine:${NinoIssueCredentialStateMachine}:live"
      Type: EXPRESS
      DefinitionUri: ../step-functions/nino_issue_credential.asl.json
      DefinitionSubstitutions:
        AuditEventPrefix: !Ref AuditEventNamePrefix
        CiMappingFunctionArn: !Ref CiMappingFunction.Version
        TimeFunctionArn: !Ref TimeFunction.Version
        CredentialSubjectFunctionArn: !Ref CredentialSubjectFunction.Version
        UserAttemptsTable: !Ref UserAttemptsTable
        MaxJwtTtlParameter: !Ref MaxJwtTtlParameter
        JwtTtlUnitParameter: !Ref JwtTtlUnitParameter
        CommonStackName: !Ref CommonStackName
        NinoUsersTable: !Ref NinoUsersTable
        JwtSignerFunction: !Ref JwtSignerFunction.Version
        SsmParametersFunction: !Ref SsmParametersFunction.Version
        CheckHmrcEventBus: !Ref CheckHmrcEventBus
        CheckHmrcEventBusSource: !FindInMap [EnvironmentConfiguration, !Ref Environment, DOMAINNAME]
        AuditEventNameVcIssued: !FindInMap [Audit, EventName, VcIssued]
        AuditEventNameEnd: !FindInMap [Audit, EventName, End]
      Logging:
        Destinations:
          - CloudWatchLogsLogGroup:
              LogGroupArn: !GetAtt NinoIssueCredentialLogGroup.Arn
        IncludeExecutionData: True
        Level: ALL
      Policies:
        - LambdaInvokePolicy:
            FunctionName: !Ref SsmParametersFunction
        - LambdaInvokePolicy:
            FunctionName: !Ref CiMappingFunction
        - LambdaInvokePolicy:
            FunctionName: !Ref TimeFunction
        - LambdaInvokePolicy:
            FunctionName: !Ref CredentialSubjectFunction
        - LambdaInvokePolicy:
            FunctionName: !Ref JwtSignerFunction
        - DynamoDBReadPolicy:
            TableName: !Ref UserAttemptsTable
        - DynamoDBReadPolicy:
            TableName: !Ref NinoUsersTable
        - DynamoDBReadPolicy:
            TableName: !Sub "{{resolve:ssm:/${CommonStackName}/SessionTableName}}"
        - DynamoDBReadPolicy:
            TableName: !Sub "{{resolve:ssm:/${CommonStackName}/PersonIdentityTableName}}"
        - EventBridgePutEventsPolicy:
            EventBusName: !Ref CheckHmrcEventBus
        - Statement:
            Effect: Allow
            Action:
              - ssm:GetParameters
              - ssm:GetParameter
            Resource:
              - !Sub "arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter${MaxJwtTtlParameter}"
              - !Sub "arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter${JwtTtlUnitParameter}"
              - !Sub "arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/check-hmrc-cri-api/contraindicationMappings"
              - !Sub "arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/check-hmrc-cri-api/contraIndicatorReasonsMapping"
              - !Sub "arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/${CommonStackName}/verifiableCredentialKmsSigningKeyId"
              - !Sub "arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/${CommonStackName}/SessionTableName"
              - !Sub "arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/${CommonStackName}/PersonIdentityTableName"
              - !Sub "arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/${CommonStackName}/verifiable-credential/issuer"
        - Statement:
            Effect: Allow
            Action: logs:*
            Resource: "*"
        - Statement:
            Effect: Allow
            Action: kms:Sign
            Resource: !ImportValue core-infrastructure-CriVcSigningKey1Arn
      PermissionsBoundary: !If
        - UsePermissionsBoundary
        - !Ref PermissionsBoundary
        - !Ref AWS::NoValue

  NinoIssueCredentialLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub "/aws/vendedlogs/states/${AWS::StackName}-NinoIssueCredential-state-machine-logs"
      RetentionInDays: 30

  PIIRedactedNinoIssueCredentialLogsSubscriptionFilterCSLS:
    Type: AWS::Logs::SubscriptionFilter
    Condition: IsNotDevLikeEnvironment
    Properties:
      DestinationArn:
        !FindInMap [PlatformConfiguration, !Ref Environment, CSLSEGRESS]
      FilterPattern: ""
      LogGroupName: !Ref PIIRedactedNinoIssueCredentialLogGroup

  NinoIssueCredentialStateMachineFailedMetric:
    Type: AWS::Logs::MetricFilter
    Properties:
      LogGroupName: !Ref NinoIssueCredentialLogGroup
      FilterPattern: '{$.type = "ExecutionFailed"}'
      MetricTransformations:
        - MetricValue: "1"
          MetricName: "NinoIssueCredentialStateMachine}-Error"
          MetricNamespace: !Sub "${AWS::StackName}/LogMessages"

  NinoIssueCredentialStateMachineAlarm:
    Type: "AWS::CloudWatch::Alarm"
    Condition: "DeployAlarms"
    Properties:
      OKActions:
        - !ImportValue core-infrastructure-AlarmTopic
        - !ImportValue platform-alarm-critical-alert-topic
      AlarmActions:
        - !ImportValue core-infrastructure-AlarmTopic
        - !ImportValue platform-alarm-critical-alert-topic
      AlarmDescription: !Sub "${NinoIssueCredentialStateMachine} failed 4 or more requests in the last hour. ${SupportManualURL}"
      AlarmName: !Sub "${AWS::StackName}-${Environment}-NinoIssueCredentialStateMachine-ExecutionsFailed-alarm"
      MetricName: "ExecutionsFailed"
      Namespace: AWS/States
      ComparisonOperator: GreaterThanThreshold
      Statistic: Sum
      DatapointsToAlarm: 1
      EvaluationPeriods: 1
      Period: 3600
      Threshold: 3
      TreatMissingData: notBreaching
      Dimensions:
        - Name: StateMachineArn
          Value: !Ref NinoIssueCredentialStateMachine

  CheckSessionStateMachineLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub "/aws/vendedlogs/states/${AWS::StackName}-CheckSession-state-machine-logs"
      RetentionInDays: 30

  PIIRedactedCheckSessionStateMachineLogsSubscriptionFilterCSLS:
    Type: AWS::Logs::SubscriptionFilter
    Condition: IsNotDevLikeEnvironment
    Properties:
      DestinationArn:
        !FindInMap [PlatformConfiguration, !Ref Environment, CSLSEGRESS]
      FilterPattern: ""
      LogGroupName: !Ref PIIRedactedCheckSessionStateMachineLogGroup

  CheckHmrcEventBus:
    Type: AWS::Events::EventBus
    Properties:
      Name: !Sub ${AWS::StackName}-CheckHmrcEventBus
      KmsKeyIdentifier: !If
        - IsDevLikeEnvironment
        - !Ref AWS::NoValue
        - Fn::ImportValue: !Sub ${TxmaStackName}-AuditEventQueueEncryptionKeyArn

  ##################################################################
  #                                                                  #
  # Nino Check Audit Event Consumer                                  #
  #                                                                  #
  ####################################################################
  AuditEventResponseReceivedRule:
    Type: AWS::Events::Rule
    Properties:
      EventBusName: !Ref CheckHmrcEventBus
      Description: Capture the audit event RESPONSE_RECEIVED
      State: ENABLED
      EventPattern:
        source:
          - !FindInMap [EnvironmentConfiguration, !Ref Environment, DOMAINNAME]
        detail-type:
          - !FindInMap [Audit, EventName, ResponseReceived]
      Targets:
        - Arn: !Sub ${AuditEventStateMachine}:live
          Id: AuditEventStateMachineResponseReceivedTarget
          RoleArn: !GetAtt EventBridgeStateMachineExecutionRole.Arn
  AuditEventRequestSentRule:
    Type: AWS::Events::Rule
    Properties:
      EventBusName: !Ref CheckHmrcEventBus
      Description: Capture the audit event REQUEST_SENT
      State: ENABLED
      EventPattern:
        source:
          - !FindInMap [EnvironmentConfiguration, !Ref Environment, DOMAINNAME]
        detail-type:
          - !FindInMap [Audit, EventName, RequestSent]
      Targets:
        - Arn: !Sub ${AuditEventStateMachine}:live
          Id: AuditEventStateMachineRequestSentTarget
          RoleArn: !GetAtt EventBridgeStateMachineExecutionRole.Arn
  AuditEventVcIssuedRule:
    Type: AWS::Events::Rule
    Properties:
      EventBusName: !Ref CheckHmrcEventBus
      Description: Capture the audit event VC_ISSUED
      State: ENABLED
      EventPattern:
        source:
          - !FindInMap [EnvironmentConfiguration, !Ref Environment, DOMAINNAME]
        detail-type:
          - !FindInMap [Audit, EventName, VcIssued]
      Targets:
        - Arn: !Sub ${AuditEventStateMachine}:live
          Id: AuditEventStateMachineVcIssuedTarget
          RoleArn: !GetAtt EventBridgeStateMachineExecutionRole.Arn
  AuditEventEndRule:
    Type: AWS::Events::Rule
    Properties:
      EventBusName: !Ref CheckHmrcEventBus
      Description: Capture the END event
      State: ENABLED
      EventPattern:
        source:
          - !FindInMap [EnvironmentConfiguration, !Ref Environment, DOMAINNAME]
        detail-type:
          - !FindInMap [Audit, EventName, End]
      Targets:
        - Arn: !Sub ${AuditEventStateMachine}:live
          Id: AuditEventStateMachineEndTarget
          RoleArn: !GetAtt EventBridgeStateMachineExecutionRole.Arn
  AuditEventAbandonedRule:
    Type: AWS::Events::Rule
    Properties:
      EventBusName: !Ref CheckHmrcEventBus
      Description: Capture the ABANDONED event
      State: ENABLED
      EventPattern:
        source:
          - !FindInMap [EnvironmentConfiguration, !Ref Environment, DOMAINNAME]
        detail-type:
          - !FindInMap [Audit, EventName, Abandoned]
      Targets:
        - Arn: !Sub ${AuditEventStateMachine}:live
          Id: AuditEventStateMachineAbandonedTarget
          RoleArn: !GetAtt EventBridgeStateMachineExecutionRole.Arn

  TxMaAuditEventRule:
    Type: AWS::Events::Rule
    Properties:
      EventBusName: !Ref CheckHmrcEventBus
      Description: Publish all formatted events from AuditEvent Step Function to TxMA audit Queue
      State: ENABLED
      EventPattern:
        source:
          - !FindInMap [EnvironmentConfiguration, !Ref Environment, DOMAINNAME]
        detail:
          timestamp: [{ "exists": true }]
          event_timestamp_ms: [{ "exists": true }]
      Targets:
        - Arn: !Sub
            - "arn:aws:sqs:${AWS::Region}:${AWS::AccountId}:${auditEventQueueName}"
            - auditEventQueueName:
                Fn::ImportValue: !Sub  "${TxmaStackName}-AuditEventQueueName"
          Id: AuditEventQueue
          InputPath: "$.detail"
          DeadLetterConfig: !If
              - IsDevLikeEnvironment
              - !Ref AWS::NoValue
              - Arn:
                  Fn::ImportValue: !Sub ${TxmaStackName}-AuditEventDLQArn

  EventBridgeStateMachineExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          - Action:
              - sts:AssumeRole
            Effect: Allow
            Principal:
              Service:
                - events.amazonaws.com
      Policies:
        - PolicyName: EventBridgeStateMachineExecutionStartExecutionPolicy
          PolicyDocument:
            Statement:
              - Action: states:StartExecution
                Effect: Allow
                Resource: !Ref AuditEventStateMachine
      PermissionsBoundary: !If
        - UsePermissionsBoundary
        - !Ref PermissionsBoundary
        - !Ref AWS::NoValue
  ##################################################################
  #                                                                  #
  # Audit Event Consumer Rule Alarms                                 #
  #                                                                  #
  ####################################################################
  TxMaAuditEventRuleAlarm:
    Condition: "DeployAlarms"
    Type: AWS::CloudWatch::Alarm
    Properties:
      OKActions:
        - !ImportValue platform-alarm-warning-alert-topic
      AlarmActions:
        - !ImportValue platform-alarm-warning-alert-topic
      AlarmDescription: !Sub "${TxMaAuditEventRule} (Failed Invocations) 4 or more requests in the last hour. ${SupportManualURL}"
      AlarmName: !Sub "${AWS::StackName}-${Environment}-TxMaAuditEventRule-FailedInvocations-alarm"
      MetricName: "FailedInvocations"
      Namespace: "AWS/Events"
      ComparisonOperator: GreaterThanThreshold
      Statistic: Sum
      DatapointsToAlarm: 1
      EvaluationPeriods: 1
      Period: 3600
      Threshold: 3
      TreatMissingData: notBreaching
      Dimensions:
        - Name: RuleName
          Value: !Select [1, !Split ["|", !Ref TxMaAuditEventRule]]
        - Name: EventBusName
          Value: !Ref CheckHmrcEventBus

  AuditEventRequestSentRuleAlarm:
    Condition: "DeployAlarms"
    Type: AWS::CloudWatch::Alarm
    Properties:
      OKActions:
        - !ImportValue platform-alarm-warning-alert-topic
      AlarmActions:
        - !ImportValue platform-alarm-warning-alert-topic
      AlarmDescription: !Sub "${AuditEventRequestSentRule} (Failed Invocations) 4 or more requests in the last hour. ${SupportManualURL}"
      AlarmName: !Sub "${AWS::StackName}-${Environment}-AuditEventRequestSentRule-FailedInvocations-alarm"
      MetricName: "FailedInvocations"
      Namespace: "AWS/Events"
      ComparisonOperator: GreaterThanThreshold
      Statistic: Sum
      DatapointsToAlarm: 1
      EvaluationPeriods: 1
      Period: 3600
      Threshold: 3
      TreatMissingData: notBreaching
      Dimensions:
        - Name: RuleName
          Value: !Select [1, !Split ["|", !Ref AuditEventRequestSentRule]]
        - Name: EventBusName
          Value: !Ref CheckHmrcEventBus

  AuditEventResponseReceivedRuleAlarm:
    Condition: "DeployAlarms"
    Type: AWS::CloudWatch::Alarm
    Properties:
      OKActions:
        - !ImportValue platform-alarm-warning-alert-topic
      AlarmActions:
        - !ImportValue platform-alarm-warning-alert-topic
      AlarmDescription: !Sub "${AuditEventResponseReceivedRule} (Failed Invocations) 4 or more requests in the last hour. ${SupportManualURL}"
      AlarmName: !Sub "${AWS::StackName}-${Environment}-AuditEventResponseReceivedRule-FailedInvocations-alarm"
      MetricName: "FailedInvocations"
      Namespace: "AWS/Events"
      ComparisonOperator: GreaterThanThreshold
      Statistic: Sum
      DatapointsToAlarm: 1
      EvaluationPeriods: 1
      Period: 3600
      Threshold: 3
      TreatMissingData: notBreaching
      Dimensions:
        - Name: RuleName
          Value: !Select [1, !Split ["|", !Ref AuditEventResponseReceivedRule]]
        - Name: EventBusName
          Value: !Ref CheckHmrcEventBus

  AuditEventVcIssuedRuleAlarm:
    Condition: "DeployAlarms"
    Type: AWS::CloudWatch::Alarm
    Properties:
      OKActions:
        - !ImportValue platform-alarm-warning-alert-topic
      AlarmActions:
        - !ImportValue platform-alarm-warning-alert-topic
      AlarmDescription: !Sub "${AuditEventVcIssuedRule} (Failed Invocations) 4 or more requests in the last hour. ${SupportManualURL}"
      AlarmName: !Sub "${AWS::StackName}-${Environment}-AuditEventVcIssuedRule-FailedInvocations-alarm"
      MetricName: "FailedInvocations"
      Namespace: "AWS/Events"
      ComparisonOperator: GreaterThanThreshold
      Statistic: Sum
      DatapointsToAlarm: 1
      EvaluationPeriods: 1
      Period: 3600
      Threshold: 3
      TreatMissingData: notBreaching
      Dimensions:
        - Name: RuleName
          Value: !Select [1, !Split ["|", !Ref AuditEventVcIssuedRule]]
        - Name: EventBusName
          Value: !Ref CheckHmrcEventBus

  AuditEventEndRuleAlarm:
    Condition: "DeployAlarms"
    Type: AWS::CloudWatch::Alarm
    Properties:
      OKActions:
        - !ImportValue platform-alarm-warning-alert-topic
      AlarmActions:
        - !ImportValue platform-alarm-warning-alert-topic
      AlarmDescription: !Sub "${AuditEventEndRule} (Failed Invocations) 4 or more requests in the last hour. ${SupportManualURL}"
      AlarmName: !Sub "${AWS::StackName}-${Environment}-AuditEventEndRule-FailedInvocations-alarm"
      MetricName: "FailedInvocations"
      Namespace: "AWS/Events"
      ComparisonOperator: GreaterThanThreshold
      Statistic: Sum
      DatapointsToAlarm: 1
      EvaluationPeriods: 1
      Period: 3600
      Threshold: 3
      TreatMissingData: notBreaching
      Dimensions:
        - Name: RuleName
          Value: !Select [1, !Split ["|", !Ref AuditEventEndRule]]
        - Name: EventBusName
          Value: !Ref CheckHmrcEventBus

  AuditEventAbandonedRuleAlarm:
    Condition: "DeployAlarms"
    Type: AWS::CloudWatch::Alarm
    Properties:
      OKActions:
        - !ImportValue platform-alarm-warning-alert-topic
      AlarmActions:
        - !ImportValue platform-alarm-warning-alert-topic
      AlarmDescription: !Sub "${AuditEventAbandonedRule} (Failed Invocations) 4 or more requests in the last hour. ${SupportManualURL}"
      AlarmName: !Sub "${AWS::StackName}-${Environment}-AuditEventAbandonedRule-FailedInvocations-alarm"
      MetricName: "FailedInvocations"
      Namespace: "AWS/Events"
      ComparisonOperator: GreaterThanThreshold
      Statistic: Sum
      DatapointsToAlarm: 1
      EvaluationPeriods: 1
      Period: 3600
      Threshold: 3
      TreatMissingData: notBreaching
      Dimensions:
        - Name: RuleName
          Value: !Select [1, !Split ["|", !Ref AuditEventAbandonedRule]]
        - Name: EventBusName
          Value: !Ref CheckHmrcEventBus

  CheckHmrcPutEventAlarm:
    Condition: "DeployAlarms"
    Type: AWS::CloudWatch::Alarm
    Properties:
      OKActions:
        - !ImportValue platform-alarm-warning-alert-topic
      AlarmActions:
        - !ImportValue platform-alarm-warning-alert-topic
      InsufficientDataActions: []
      AlarmDescription: !Sub "${AWS::StackName}-${Environment} PutEvents (PutEvents Failed) 4 or more requests in the last hour. ${SupportManualURL}"
      AlarmName: !Sub "${AWS::StackName}-${Environment}-CheckHmrcEventBus-PutEventsApproximateFailedCount-alarm"
      MetricName: PutEventsApproximateFailedCount
      ComparisonOperator: GreaterThanThreshold
      Namespace: "AWS/Events"
      Statistic: Sum
      DatapointsToAlarm: 1
      EvaluationPeriods: 1
      Period: 3600
      Threshold: 3
      TreatMissingData: notBreaching

  ##################################################################
  #                                                                  #
  # Canary Alarms                                                    #
  #                                                                  #
  ####################################################################
  #Step function alarms

  CheckSessionStateMachineFailedCanary:
    Type: AWS::CloudWatch::Alarm
    Condition: UseCanaryDeploymentAlarms
    Properties:
      ActionsEnabled: true
      AlarmActions:
        - !ImportValue platform-alarm-warning-alert-topic
      OKActions:
        - !ImportValue platform-alarm-warning-alert-topic
      AlarmDescription: !Sub "Errors returned from the CheckSessionStateMachine"
      MetricName: ExecutionsFailed
      Dimensions:
        - Name: StateMachineArn
          Value: !Sub "arn:aws:states:${AWS::Region}:${AWS::AccountId}:stateMachine:${CheckSessionStateMachine}"
        - Name: Alias
          Value: 'live'
      Namespace: AWS/States
      Statistic: Sum
      Unit: Count
      Period: 60
      EvaluationPeriods: 1
      Threshold: 1
      ComparisonOperator: GreaterThanOrEqualToThreshold
      TreatMissingData: notBreaching

  AbandonStateMachineFailedCanary:
    Type: AWS::CloudWatch::Alarm
    Condition: UseCanaryDeploymentAlarms
    Properties:
      ActionsEnabled: true
      AlarmActions:
        - !ImportValue platform-alarm-warning-alert-topic
      OKActions:
        - !ImportValue platform-alarm-warning-alert-topic
      AlarmDescription: !Sub "Errors returned from the AbandonStateMachine"
      MetricName: ExecutionsFailed
      Dimensions:
        - Name: StateMachineArn
          Value: !Sub "arn:aws:states:${AWS::Region}:${AWS::AccountId}:stateMachine:${AbandonStateMachine}"
        - Name: Alias
          Value: 'live'
      Namespace: AWS/States
      Statistic: Sum
      Unit: Count
      Period: 60
      EvaluationPeriods: 1
      Threshold: 1
      ComparisonOperator: GreaterThanOrEqualToThreshold
      TreatMissingData: notBreaching

  NinoCheckStateMachineFailedCanary:
    Type: AWS::CloudWatch::Alarm
    Condition: UseCanaryDeploymentAlarms
    Properties:
      ActionsEnabled: true
      AlarmActions:
        - !ImportValue platform-alarm-warning-alert-topic
      OKActions:
        - !ImportValue platform-alarm-warning-alert-topic
      AlarmDescription: !Sub "Errors returned from the NinoCheckStateMachine"
      MetricName: ExecutionsFailed
      Dimensions:
        - Name: StateMachineArn
          Value: !Sub "arn:aws:states:${AWS::Region}:${AWS::AccountId}:stateMachine:${NinoCheckStateMachine}"
        - Name: Alias
          Value: 'live'
      Namespace: AWS/States
      Statistic: Sum
      Unit: Count
      Period: 60
      EvaluationPeriods: 1
      Threshold: 1
      ComparisonOperator: GreaterThanOrEqualToThreshold
      TreatMissingData: notBreaching

  NinoIssueCredentialStateMachineFailedCanary:
    Type: AWS::CloudWatch::Alarm
    Condition: UseCanaryDeploymentAlarms
    Properties:
      ActionsEnabled: true
      AlarmActions:
        - !ImportValue platform-alarm-warning-alert-topic
      OKActions:
        - !ImportValue platform-alarm-warning-alert-topic
      AlarmDescription: !Sub "Errors returned from the NinoIssueCredentialStateMachine"
      MetricName: ExecutionsFailed
      Dimensions:
        - Name: StateMachineArn
          Value: !Sub "arn:aws:states:${AWS::Region}:${AWS::AccountId}:stateMachine:${NinoIssueCredentialStateMachine"
        - Name: Alias
          Value: 'live'
      Namespace: AWS/States
      Statistic: Sum
      Unit: Count
      Period: 60
      EvaluationPeriods: 1
      Threshold: 1
      ComparisonOperator: GreaterThanOrEqualToThreshold
      TreatMissingData: notBreaching

  AuditEventStateMachineFailedCanary:
    Type: AWS::CloudWatch::Alarm
    Condition: UseCanaryDeploymentAlarms
    Properties:
      ActionsEnabled: true
      AlarmActions:
        - !ImportValue platform-alarm-warning-alert-topic
      OKActions:
        - !ImportValue platform-alarm-warning-alert-topic
      AlarmDescription: !Sub "Errors returned from the AuditEventStateMachine"
      MetricName: ExecutionsFailed
      Dimensions:
        - Name: StateMachineArn
          Value: !Sub "arn:aws:states:${AWS::Region}:${AWS::AccountId}:stateMachine:${AuditEventStateMachine}"
        - Name: Alias
          Value: 'live'
      Namespace: AWS/States
      Statistic: Sum
      Unit: Count
      Period: 60
      EvaluationPeriods: 1
      Threshold: 1
      ComparisonOperator: GreaterThanOrEqualToThreshold
      TreatMissingData: notBreaching

  OTGFunctionCanaryErrors:
    Type: AWS::CloudWatch::Alarm
    Condition: UseCanaryDeploymentAlarms
    Properties:
      ActionsEnabled: true
      AlarmActions:
        - !ImportValue platform-alarm-warning-alert-topic
      OKActions:
        - !ImportValue platform-alarm-warning-alert-topic
      AlarmDescription: !Sub "Errors returned from the OTGFunction Lambda."
      MetricName: Errors
      Dimensions:
        - Name: Resource
          Value: !Sub "${AWS::StackName}-OTGLookupFunction:live"
        - Name: FunctionName
          Value: !Ref OTGFunction
        - Name: ExecutedVersion
          Value: !GetAtt OTGFunction.Version.Version
      Namespace: AWS/Lambda
      Statistic: Sum
      Unit: Count
      Period: 60
      EvaluationPeriods: 1
      Threshold: 1
      ComparisonOperator: GreaterThanOrEqualToThreshold
      TreatMissingData: notBreaching

  MatchingFunctionCanaryErrors:
    Type: AWS::CloudWatch::Alarm
    Condition: UseCanaryDeploymentAlarms
    Properties:
      ActionsEnabled: true
      AlarmActions:
        - !ImportValue platform-alarm-warning-alert-topic
      OKActions:
        - !ImportValue platform-alarm-warning-alert-topic
      AlarmDescription: !Sub "Errors returned from the MatchingFunction Lambda."
      MetricName: Errors
      Dimensions:
        - Name: Resource
          Value: !Sub "${AWS::StackName}-MatchingLookupFunction:live"
        - Name: FunctionName
          Value: !Ref MatchingFunction
        - Name: ExecutedVersion
          Value: !GetAtt MatchingFunction.Version.Version
      Namespace: AWS/Lambda
      Statistic: Sum
      Unit: Count
      Period: 60
      EvaluationPeriods: 1
      Threshold: 1
      ComparisonOperator: GreaterThanOrEqualToThreshold
      TreatMissingData: notBreaching

  SsmParametersFunctionCanaryErrors:
    Type: AWS::CloudWatch::Alarm
    Condition: UseCanaryDeploymentAlarms
    Properties:
      ActionsEnabled: true
      AlarmActions:
        - !ImportValue platform-alarm-warning-alert-topic
      OKActions:
        - !ImportValue platform-alarm-warning-alert-topic
      AlarmDescription: !Sub "Errors returned from the SsmParametersFunction Lambda."
      MetricName: Errors
      Dimensions:
        - Name: Resource
          Value: !Sub "${AWS::StackName}-SsmParametersLookupFunction:live"
        - Name: FunctionName
          Value: !Ref SsmParametersFunction
        - Name: ExecutedVersion
          Value: !GetAtt SsmParametersFunction.Version.Version
      Namespace: AWS/Lambda
      Statistic: Sum
      Unit: Count
      Period: 60
      EvaluationPeriods: 1
      Threshold: 1
      ComparisonOperator: GreaterThanOrEqualToThreshold
      TreatMissingData: notBreaching

  CiMappingFunctionCanaryErrors:
    Type: AWS::CloudWatch::Alarm
    Condition: UseCanaryDeploymentAlarms
    Properties:
      ActionsEnabled: true
      AlarmActions:
        - !ImportValue platform-alarm-warning-alert-topic
      OKActions:
        - !ImportValue platform-alarm-warning-alert-topic
      AlarmDescription: !Sub "Errors returned from the CiMappingFunction Lambda."
      MetricName: Errors
      Dimensions:
        - Name: Resource
          Value: !Sub "${AWS::StackName}-CiMappingLookupFunction:live"
        - Name: FunctionName
          Value: !Ref CiMappingFunction
        - Name: ExecutedVersion
          Value: !GetAtt CiMappingFunction.Version.Version
      Namespace: AWS/Lambda
      Statistic: Sum
      Unit: Count
      Period: 60
      EvaluationPeriods: 1
      Threshold: 1
      ComparisonOperator: GreaterThanOrEqualToThreshold
      TreatMissingData: notBreaching

  TimeFunctionCanaryErrors:
    Type: AWS::CloudWatch::Alarm
    Condition: UseCanaryDeploymentAlarms
    Properties:
      ActionsEnabled: true
      AlarmActions:
        - !ImportValue platform-alarm-warning-alert-topic
      OKActions:
        - !ImportValue platform-alarm-warning-alert-topic
      AlarmDescription: !Sub "Errors returned from the TimeFunction Lambda."
      MetricName: Errors
      Dimensions:
        - Name: Resource
          Value: !Sub "${AWS::StackName}-TimeLookupFunction:live"
        - Name: FunctionName
          Value: !Ref TimeFunction
        - Name: ExecutedVersion
          Value: !GetAtt TimeFunction.Version.Version
      Namespace: AWS/Lambda
      Statistic: Sum
      Unit: Count
      Period: 60
      EvaluationPeriods: 1
      Threshold: 1
      ComparisonOperator: GreaterThanOrEqualToThreshold
      TreatMissingData: notBreaching

  CredentialSubjectFunctionCanaryErrors:
    Type: AWS::CloudWatch::Alarm
    Condition: UseCanaryDeploymentAlarms
    Properties:
      ActionsEnabled: true
      AlarmActions:
        - !ImportValue platform-alarm-warning-alert-topic
      OKActions:
        - !ImportValue platform-alarm-warning-alert-topic
      AlarmDescription: !Sub "Errors returned from the CredentialSubjectFunction Lambda."
      MetricName: Errors
      Dimensions:
        - Name: Resource
          Value: !Sub "${AWS::StackName}-CredentialSubjectLookupFunction:live"
        - Name: FunctionName
          Value: !Ref CredentialSubjectFunction
        - Name: ExecutedVersion
          Value: !GetAtt CredentialSubjectFunction.Version.Version
      Namespace: AWS/Lambda
      Statistic: Sum
      Unit: Count
      Period: 60
      EvaluationPeriods: 1
      Threshold: 1
      ComparisonOperator: GreaterThanOrEqualToThreshold
      TreatMissingData: notBreaching

  JwtSignerFunctionCanaryErrors:
    Type: AWS::CloudWatch::Alarm
    Condition: UseCanaryDeploymentAlarms
    Properties:
      ActionsEnabled: true
      AlarmActions:
        - !ImportValue platform-alarm-warning-alert-topic
      OKActions:
        - !ImportValue platform-alarm-warning-alert-topic
      AlarmDescription: !Sub "Errors returned from the JwtSignerFunction Lambda."
      MetricName: Errors
      Dimensions:
        - Name: Resource
          Value: !Sub "${AWS::StackName}-JwtSignerLookupFunction:live"
        - Name: FunctionName
          Value: !Ref JwtSignerFunction
        - Name: ExecutedVersion
          Value: !GetAtt JwtSignerFunction.Version.Version
      Namespace: AWS/Lambda
      Statistic: Sum
      Unit: Count
      Period: 60
      EvaluationPeriods: 1
      Threshold: 1
      ComparisonOperator: GreaterThanOrEqualToThreshold
      TreatMissingData: notBreaching

  PIIRedactFunctionCanaryErrors:
    Type: AWS::CloudWatch::Alarm
    Condition: UseCanaryDeploymentAlarms
    Properties:
      ActionsEnabled: true
      AlarmActions:
        - !ImportValue platform-alarm-warning-alert-topic
      OKActions:
        - !ImportValue platform-alarm-warning-alert-topic
      AlarmDescription: !Sub "Errors returned from the PIIRedactFunction Lambda."
      MetricName: Errors
      Dimensions:
        - Name: Resource
          Value: !Sub "${AWS::StackName}-PIIRedactLookupFunction:live"
        - Name: FunctionName
          Value: !Ref PIIRedactFunction
        - Name: ExecutedVersion
          Value: !GetAtt PIIRedactFunction.Version.Version
      Namespace: AWS/Lambda
      Statistic: Sum
      Unit: Count
      Period: 60
      EvaluationPeriods: 1
      Threshold: 1
      ComparisonOperator: GreaterThanOrEqualToThreshold
      TreatMissingData: notBreaching

  ###############################################################################

  AuditEventStateMachine:
    Type: AWS::Serverless::StateMachine
    Properties:
      AutoPublishAlias: live
      DeploymentPreference:
        Type: !Ref StepFunctionsDeploymentPreference
        Interval: 15
        Percentage: 10
        Alarms: !If
          - UseCanaryDeploymentAlarms
          - - !Ref CredentialSubjectFunctionCanaryErrors
            - !Ref TimeFunctionCanaryErrors
            - !Ref AuditEventStateMachineFailedCanary
          - !Ref AWS::NoValue
        StateMachineVersionArn: !Sub "arn:aws:states:${AWS::Region}:${AWS::AccountId}:stateMachine:${AuditEventStateMachine}:live"
      Type: EXPRESS
      DefinitionUri: ../step-functions/audit_event.asl.json
      DefinitionSubstitutions:
        CredentialSubjectFunctionArn: !Ref CredentialSubjectFunction.Version
        TimeFunctionArn: !Ref TimeFunction.Version
        CheckHmrcEventBus: !Ref CheckHmrcEventBus
        CheckHmrcEventBusSource: !FindInMap [EnvironmentConfiguration, !Ref Environment, DOMAINNAME]
      Logging:
        Destinations:
          - CloudWatchLogsLogGroup:
              LogGroupArn: !GetAtt AuditEventStateMachineLogGroup.Arn
        IncludeExecutionData: True
        Level: ALL
      Policies:
        - LambdaInvokePolicy:
            FunctionName: !Ref CredentialSubjectFunction
        - LambdaInvokePolicy:
            FunctionName: !Ref TimeFunction
        - EventBridgePutEventsPolicy:
            EventBusName: !Ref CheckHmrcEventBus
        - Statement:
            Effect: Allow
            Action: logs:*
            Resource: "*"
      PermissionsBoundary: !If
        - UsePermissionsBoundary
        - !Ref PermissionsBoundary
        - !Ref AWS::NoValue

  AuditEventStateMachineLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub /aws/vendedlogs/states/${AWS::StackName}-AuditEvent-state-machine-logs
      RetentionInDays: 30

  PIIRedactedAuditEventStateMachineLogsSubscriptionFilterCSLS:
    Type: AWS::Logs::SubscriptionFilter
    Condition: IsNotDevLikeEnvironment
    Properties:
      DestinationArn:
        !FindInMap [PlatformConfiguration, !Ref Environment, CSLSEGRESS]
      FilterPattern: ""
      LogGroupName: !Ref PIIRedactedAuditEventStateMachineLogGroup

  ####################################################################
  #                                                                  #
  #  Metrics                                                         #
  #                                                                  #
  ####################################################################
  SuccessfulNinoCheckMetric:
    Type: AWS::Logs::MetricFilter
    Properties:
      LogGroupName: !Ref NinoCheckStateMachineLogGroup
      FilterPattern: '{($.details.name = "Store Successful Attempt")}'
      MetricTransformations:
        - MetricValue: 1
          MetricName: SuccessfulFirstAttemptMetric
          MetricNamespace: !Ref CriIdentifier

  RetryAttemptsSentMetric:
    Type: AWS::Logs::MetricFilter
    Properties:
      LogGroupName: !Ref NinoCheckStateMachineLogGroup
      FilterPattern: '{($.details.name = "Send Retry")}'
      MetricTransformations:
        - MetricValue: 1
          MetricName: RetryAttemptsSentMetric
          MetricNamespace: !Ref CriIdentifier

  FailedHMRCAuthMetric:
    Type: AWS::Logs::MetricFilter
    Properties:
      LogGroupName: !Ref NinoCheckStateMachineLogGroup
      FilterPattern: '{($.details.name = "Err: Failed Auth")}'
      MetricTransformations:
        - MetricValue: 1
          MetricName: FailedHMRCAuthMetric
          MetricNamespace: !Ref CriIdentifier

  HMRCAPIErrorMetric:
    Type: AWS::Logs::MetricFilter
    Properties:
      LogGroupName: !Ref NinoCheckStateMachineLogGroup
      FilterPattern: '{($.details.name = "Err: API Error")}'
      MetricTransformations:
        - MetricValue: 1
          MetricName: HMRCAPIErrorMetric
          MetricNamespace: !Ref CriIdentifier

  MatchingLambdaErrorMetric:
    Type: AWS::Logs::MetricFilter
    Properties:
      LogGroupName: !Ref NinoCheckStateMachineLogGroup
      FilterPattern: '{($.details.name = "Err: Matching Lambda Exception")}'
      MetricTransformations:
        - MetricValue: 1
          MetricName: MatchingLambdaErrorMetric
          MetricNamespace: !Ref CriIdentifier

  DeceasedUserMetric:
    Type: AWS::Logs::MetricFilter
    Properties:
      LogGroupName: !Ref NinoCheckStateMachineLogGroup
      FilterPattern: '{($.details.name = "Store Deceased Attempt")}'
      MetricTransformations:
        - MetricValue: 1
          MetricName: DeceasedUserMetric
          MetricNamespace: !Ref CriIdentifier

  AttemptsExceededMetric:
    Type: AWS::Logs::MetricFilter
    Properties:
      LogGroupName: !Ref NinoCheckStateMachineLogGroup
      FilterPattern: '{($.details.name = "Err: Attempts exceeded")}'
      MetricTransformations:
        - MetricValue: 1
          MetricName: AttemptsExceededMetric
          MetricNamespace: !Ref CriIdentifier

  InvalidSessionErrorMetric:
    Type: AWS::Logs::MetricFilter
    Properties:
      LogGroupName: !Ref NinoCheckStateMachineLogGroup
      FilterPattern: '{($.details.name = "Err: Invalid Session")}'
      MetricTransformations:
        - MetricValue: 1
          MetricName: InvalidSessionErrorMetric
          MetricNamespace: !Ref CriIdentifier

  CIRaisedMetric:
    Type: AWS::Logs::MetricFilter
    Properties:
      LogGroupName: !Ref NinoIssueCredentialLogGroup
      FilterPattern: '{($.details.name = "Fetch CI")}'
      MetricTransformations:
        - MetricValue: 1
          MetricName: CIRaisedMetric
          MetricNamespace: !Ref CriIdentifier

  VCIssuedMetric:
    Type: AWS::Logs::MetricFilter
    Properties:
      LogGroupName: !Ref NinoIssueCredentialLogGroup
      FilterPattern: '{($.details.name = "Create Signed JWT")}'
      MetricTransformations:
        - MetricValue: 1
          MetricName: VCIssuedMetric
          MetricNamespace: !Ref CriIdentifier

  AbandonedJourneyMetric:
    Type: AWS::Logs::MetricFilter
    Properties:
      LogGroupName: !Ref AbandonStateMachineLogGroup
      FilterPattern: '{($.details.name = "Clear Auth Code")}'
      MetricTransformations:
        - MetricValue: 1
          MetricName: AbandonedAuthMetric
          MetricNamespace: !Ref CriIdentifier

  ####################################################################
  #                                                                  #
  # Log Groups for Slunk (PII Redacted)                              #
  #                                                                  #
  ####################################################################

  PIIRedactedNinoCheckStateMachineLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub "/aws/vendedlogs/states/${AWS::StackName}-NinoCheck-state-machine-logs-pii-redacted"
      RetentionInDays: 30

  PIIRedactedAbandonStateMachineLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub "/aws/vendedlogs/states/${AWS::StackName}-Abandon-state-machine-logs-pii-redacted"
      RetentionInDays: 30

  PIIRedactedNinoIssueCredentialLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub "/aws/vendedlogs/states/${AWS::StackName}-NinoIssueCredential-state-machine-logs-pii-redacted"
      RetentionInDays: 30

  PIIRedactedCheckSessionStateMachineLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub "/aws/vendedlogs/states/${AWS::StackName}-CheckSession-state-machine-logs-pii-redacted"
      RetentionInDays: 30

  PIIRedactedAuditEventStateMachineLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub /aws/vendedlogs/states/${AWS::StackName}-AuditEvent-state-machine-logs-pii-redacted
      RetentionInDays: 30

  ####################################################################
  #                                                                  #
  # PIIRedactFunction SubscriptionFilter                             #
  #                                                                  #
  ####################################################################
  PIIRedactFunction:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Sourcemap: true
    Properties:
      DeploymentPreference:
        Type: !Ref LambdaDeploymentPreference
        Alarms: !If
          - UseCanaryDeploymentAlarms
          - [!Ref PIIRedactFunctionCanaryErrors]
          - [!Ref AWS::NoValue]
        Role: !GetAtt CodeDeployServiceRole.Arn
      Handler: lambdas/pii-redact/src/pii-redact-handler.lambdaHandler
      LoggingConfig:
        LogGroup: !Sub /aws/lambda/${AWS::StackName}/PIIRedactFunction
      CodeSigningConfigArn:
        !If [ EnforceCodeSigning, !Ref CodeSigningConfigArn, !Ref AWS::NoValue ]
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref RedactionLogStreamTrackingTable
        - Statement:
            Effect: Allow
            Action: logs:*
            Resource: "*"
        - Statement:
            Effect: Allow
            Action: lambda:*
            Resource: "*"
      Environment:
        Variables:
          POWERTOOLS_SERVICE_NAME: !Sub "${CriIdentifier}-PIIRedact"
          RedactionLogStreamTrackingTable: !Ref RedactionLogStreamTrackingTable

  PIIRedactFunctionLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub /aws/lambda/${AWS::StackName}/PIIRedactFunction
      RetentionInDays: 30

  PIIRedactFunctionCloudWatchPermissions:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !GetAtt PIIRedactFunction.Arn
      Action: lambda:InvokeFunction
      Principal: !Join [ ".", [ "logs", !Ref "AWS::Region", "amazonaws.com" ] ]
      SourceAccount: !Ref AWS::AccountId

  NinoCheckStateMachineLogsSubscriptionFilter:
    Type: AWS::Logs::SubscriptionFilter
    DependsOn: PIIRedactFunctionCloudWatchPermissions
    Properties:
      FilterName: "PII Redaction"
      DestinationArn: !GetAtt PIIRedactFunction.Arn
      FilterPattern: ""
      LogGroupName: !Ref NinoCheckStateMachineLogGroup

  AbandonStateMachineLogsSubscriptionFilter:
    Type: AWS::Logs::SubscriptionFilter
    DependsOn: PIIRedactFunctionCloudWatchPermissions
    Properties:
      FilterName: "PII Redaction"
      DestinationArn: !GetAtt PIIRedactFunction.Arn
      FilterPattern: ""
      LogGroupName: !Ref AbandonStateMachineLogGroup

  NinoIssueCredentialLogsSubscriptionFilter:
    Type: AWS::Logs::SubscriptionFilter
    DependsOn: PIIRedactFunctionCloudWatchPermissions
    Properties:
      FilterName: "PII Redaction"
      DestinationArn: !GetAtt PIIRedactFunction.Arn
      FilterPattern: ""
      LogGroupName: !Ref NinoIssueCredentialLogGroup

  CheckSessionStateMachineLogsSubscriptionFilter:
    Type: AWS::Logs::SubscriptionFilter
    DependsOn: PIIRedactFunctionCloudWatchPermissions
    Properties:
      FilterName: "PII Redaction"
      DestinationArn: !GetAtt PIIRedactFunction.Arn
      FilterPattern: ""
      LogGroupName: !Ref CheckSessionStateMachineLogGroup

  AuditEventStateMachineLogsSubscriptionFilter:
    Type: AWS::Logs::SubscriptionFilter
    DependsOn: PIIRedactFunctionCloudWatchPermissions
    Properties:
      FilterName: "PII Redaction"
      DestinationArn: !GetAtt PIIRedactFunction.Arn
      FilterPattern: ""
      LogGroupName: !Ref AuditEventStateMachineLogGroup

  ####################################################################
  #                                                                  #
  # Code Deploy Service Role                                       #
  #                                                                  #
  ####################################################################

  CodeDeployServiceRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Action:
              - sts:AssumeRole
            Effect: Allow
            Principal:
              Service:
                - codedeploy.amazonaws.com
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSCodeDeployRoleForLambda
      PermissionsBoundary: !If [ UsePermissionsBoundary, !Ref PermissionsBoundary, !Ref AWS::NoValue ]

##################################################################
#                                                                  #
#  Stack Outputs                                                   #
#                                                                  #
####################################################################
Outputs:
  SsmParametersFunctionArn:
    Description: SsmParameters Lambda Function ARN
    Value: !GetAtt SsmParametersFunction.Arn
  ApiGatewayId:
    Description: API GatewayID of the Nino Check HMRC CRI API
    Value: !Ref PublicNinoCheckApi
    Export:
      Name: !Sub ${AWS::StackName}-ApiGatewayId
  PublicApiGatewayId:
    Description: API Gateway ID of the public Nino Check HMRC CRI API
    Value: !Ref PublicNinoCheckApi
    Export:
      Name: !Sub ${AWS::StackName}-PublicApiGatewayId
  PrivateApiGatewayId:
    Description: API Gateway ID of the private Nino Check HMRC API
    Value: !Ref PrivateNinoCheckApi
    Export:
      Name: !Sub ${AWS::StackName}-PrivateApiGatewayId
  NinoCheckStateMachineArn:
    Description: Nino Check state machine ARN
    Value: !Ref NinoCheckStateMachine
  CheckSessionStateMachineArn:
    Description: Session Check state machine ARN
    Value: !Ref CheckSessionStateMachine
  NinoIssueCredentialStateMachineArn:
    Description: Nino Issue Credential state machine ARN
    Value: !Ref NinoIssueCredentialStateMachine
  CommonStackName:
    Description: Common Stack Name
    Value: !Ref CommonStackName
  UserAttemptsTable:
    Description: UserAttemptsTable table name
    Value: !Ref UserAttemptsTable
  NinoUsersTable:
    Description: NinoUsersTable table name
    Value: !Ref NinoUsersTable
  AbandonStateMachineArn:
    Description: Abandon state machine ARN
    Value: !Ref AbandonStateMachine
  AuditEventResponseReceivedRule:
    Description: AuditEvent Response Received Rule
    Value: !Ref AuditEventResponseReceivedRule
  AuditEventResponseReceivedRuleArn:
    Description: AuditEvent Response Received Rule Arn
    Value: !GetAtt AuditEventResponseReceivedRule.Arn
  AuditEventRequestSentRule:
    Description: AuditEvent Request Sent Rule
    Value: !Ref AuditEventRequestSentRule
  AuditEventRequestSentRuleArn:
    Description: AuditEvent Request Sent Rule Arn
    Value: !GetAtt AuditEventRequestSentRule.Arn
  AuditEventAbandonedRule:
    Description: AuditEvent Abandon Rule
    Value: !Ref AuditEventAbandonedRule
  AuditEventAbandonedRuleArn:
    Description: AuditEvent Abandon Rule Arn
    Value: !GetAtt AuditEventAbandonedRule.Arn
  AuditEventVcIssuedRule:
    Description: AuditEvent VC Issued Rule
    Value: !Ref AuditEventVcIssuedRule
  AuditEventVcIssuedRuleArn:
    Description: AuditEvent VC Issued Rule Arn
    Value: !GetAtt AuditEventVcIssuedRule.Arn
  AuditEventEndRule:
    Description: AuditEvent End Rule
    Value: !Ref AuditEventEndRule
  AuditEventEndRuleArn:
    Description: AuditEvent Rule Arn
    Value: !GetAtt AuditEventEndRule.Arn
  TxMaAuditEventRule:
    Description: TxMaAuditEvent End Rule
    Value: !Ref TxMaAuditEventRule
  TxMaAuditEventRuleArn:
    Description: TxMaAuditEvent Rule Arn
    Value: !GetAtt TxMaAuditEventRule.Arn
